<!doctype html>
<html>
<head>
    <title>Scale</title>
    <style type="text/css">
        body {
            background: #000;
        }
    </style>
</head>
<body>
<div class="content"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
<script type="text/javascript">
    var holder = d3.select('.content');
    var svg = holder.append('svg')
        .attr('width', 1000)
        .attr('height', 1000);

    var defs = svg.append('svg:defs');

    d3.json('/static/data/planets.json', function(error, planetData) {
        var patternWidth = 618
        var patternHeight = 200;
        var max = d3.max(planetData, function(d){
            return d.radius;
        });

        planetData.forEach(function(planet){
            planet.scale = planet.radius / max;
        });

        var patterns = defs.selectAll('pattern')
                .data(planetData)
            .enter().append('svg:pattern')
                .attr('id', function(d){ return d.name; })
                .attr('width', patternWidth)
                .attr('height', patternHeight)
                .attr('y', patternHeight/2)
                .attr('x', Math.random()*patternWidth)
                .attr('patternUnits', 'userSpaceOnUse');

        patterns.append('image')
            .attr('xlink:href', function(d){ return d.texture; })
            .attr('width', patternWidth)
            .attr('height', patternHeight);

        var solarSystem = svg.append('g')
            .classed({
                'solar-system': true
            });
        var offset = 100;
        var planets = solarSystem.selectAll('g.planet')
                .data(planetData)
            .enter().append('g')
                .classed({
                    'planet': true
                })
                .attr('transform', function(d, i){
                    var scaledRadius = (100*d.scale);
                    offset += scaledRadius;
                    var trans = 'translate(' + offset + ',100)';
                    offset += scaledRadius + 100;
                    return trans;
                })
                .style('fill', function(d){
                    return 'url(#' + d.name + ')';
                })
                .append('circle')
                    .attr('r', 100)
                    .attr('transform', function(d){
                        return 'scale(' + d.scale + ')';
                    })
                    .on('click', rotate);

        var rotating = planetData.map(function(){ return false; });
        function rotate(planet, i){
            var matchingPattern = patterns.filter(function(d, index){
                return index === i;
            });
            if ( rotating[i] ) {
                matchingPattern.transition();
            } else {
                var start = matchingPattern.attr('x');
                var end = start - patternWidth;
                matchingPattern.transition()
                    .duration(5000)
                    .ease('linear')
                    .attr('x', end);
            }
            rotating[i] = !rotating[i];
        }
    });

</script>
</body>
</html>